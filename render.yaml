# =============================================================================
# HowWePlan - Render Blueprint
# Single Backend Entry Point with Internal Microservices
# =============================================================================
#
# This blueprint deploys:
#   - api-gateway (PUBLIC) - Single entry point at port 443
#   - All microservices (PRIVATE) - Internal only, no public access
#
# Services communicate via Render's private network using service names.
#
# Deploy: Connect repo to Render and select "Blueprint" deployment
# =============================================================================

services:
  # ===========================================================================
  # PUBLIC SERVICE (Single Entry Point)
  # ===========================================================================
  
  - type: web
    name: api-gateway
    runtime: docker
    dockerfilePath: ./services/api-gateway/Dockerfile
    dockerContext: ./services/api-gateway
    plan: starter
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3000"
      - key: CORS_ALLOWED_ORIGINS
        value: https://howweplan-user.vercel.app,https://howweplan-agent.vercel.app,https://howweplan-admin.vercel.app
      # Internal service URLs (Render private network)
      - key: IDENTITY_SERVICE_URL
        value: http://identity:3011
      - key: REQUESTS_SERVICE_URL
        value: http://requests:3012
      - key: MATCHING_SERVICE_URL
        value: http://matching:3013
      - key: ITINERARIES_SERVICE_URL
        value: http://itineraries:3014
      - key: BOOKING_PAYMENTS_SERVICE_URL
        value: http://booking-payments:3015
      - key: MESSAGING_SERVICE_URL
        value: http://messaging:3016
      - key: DISPUTES_SERVICE_URL
        value: http://disputes:3017
      - key: REVIEWS_SERVICE_URL
        value: http://reviews:3018
      - key: NOTIFICATIONS_SERVICE_URL
        value: http://notifications:3019
      - key: AUDIT_SERVICE_URL
        value: http://audit:3010
      - key: EVENT_BUS_SERVICE_URL
        value: http://event-bus:4000
      # JWT
      - key: JWT_ALGORITHM
        value: RS256
      - key: JWT_ISSUER
        value: tripcomposer
      - key: JWT_AUDIENCE
        value: tripcomposer-services

  # ===========================================================================
  # PRIVATE SERVICES (Internal Only)
  # ===========================================================================

  - type: pserv
    name: event-bus
    runtime: docker
    dockerfilePath: ./services/event-bus-service/Dockerfile
    dockerContext: ./services/event-bus-service
    plan: starter
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "4000"
      - key: LOG_LEVEL
        value: info

  - type: pserv
    name: audit
    runtime: docker
    dockerfilePath: ./services/audit/Dockerfile
    dockerContext: ./services/audit
    plan: starter
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3010"
      - key: LOCAL_DEV_MODE
        value: "false"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: INTERNAL_SERVICE_SECRET
        sync: false
      - key: LOG_LEVEL
        value: info

  - type: pserv
    name: identity
    runtime: docker
    dockerfilePath: ./services/identity/Dockerfile
    dockerContext: ./services/identity
    plan: starter
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3011"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: JWT_ALGORITHM
        value: RS256
      - key: JWT_ISSUER
        value: tripcomposer
      - key: JWT_AUDIENCE
        value: tripcomposer-services
      - key: EVENT_BUS_URL
        value: http://event-bus:4000
      - key: EVENT_BUS_API_KEY
        sync: false
      - key: LOG_LEVEL
        value: info

  - type: pserv
    name: requests
    runtime: docker
    dockerfilePath: ./services/requests/Dockerfile
    dockerContext: ./services/requests
    plan: starter
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3012"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: JWT_ALGORITHM
        value: RS256
      - key: JWT_ISSUER
        value: tripcomposer
      - key: JWT_AUDIENCE
        value: tripcomposer-services
      - key: EVENT_BUS_URL
        value: http://event-bus:4000
      - key: DAILY_REQUEST_CAP
        value: "5"
      - key: MAX_OPEN_REQUESTS
        value: "3"
      - key: LOG_LEVEL
        value: info

  - type: pserv
    name: matching
    runtime: docker
    dockerfilePath: ./services/matching/Dockerfile
    dockerContext: ./services/matching
    plan: starter
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3013"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: EVENT_BUS_URL
        value: http://event-bus:4000
      - key: EVENT_BUS_API_KEY
        sync: false
      - key: LOG_LEVEL
        value: info

  - type: pserv
    name: itineraries
    runtime: docker
    dockerfilePath: ./services/itineraries/Dockerfile
    dockerContext: ./services/itineraries
    plan: starter
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3014"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: JWT_ALGORITHM
        value: RS256
      - key: JWT_ISSUER
        value: tripcomposer
      - key: JWT_AUDIENCE
        value: tripcomposer-services
      - key: EVENT_BUS_URL
        value: http://event-bus:4000
      - key: INTERNAL_API_KEY
        sync: false
      - key: LOG_LEVEL
        value: info

  - type: pserv
    name: booking-payments
    runtime: docker
    dockerfilePath: ./services/booking-payments/Dockerfile
    dockerContext: ./services/booking-payments
    plan: starter
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3015"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: JWT_ALGORITHM
        value: RS256
      - key: JWT_ISSUER
        value: tripcomposer
      - key: JWT_AUDIENCE
        value: tripcomposer-services
      - key: EVENT_BUS_URL
        value: http://event-bus:4000
      - key: EVENT_BUS_API_KEY
        sync: false
      - key: RAZORPAY_KEY_ID
        sync: false
      - key: RAZORPAY_KEY_SECRET
        sync: false
      - key: RAZORPAY_WEBHOOK_SECRET
        sync: false
      - key: ENABLE_LIVE_PAYMENTS
        value: "false"
      - key: INTERNAL_API_KEY
        sync: false
      - key: PLATFORM_COMMISSION_RATE
        value: "0.10"
      - key: LOG_LEVEL
        value: info

  - type: pserv
    name: messaging
    runtime: docker
    dockerfilePath: ./services/messaging/Dockerfile
    dockerContext: ./services/messaging
    plan: starter
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3016"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: JWT_ALGORITHM
        value: RS256
      - key: JWT_ISSUER
        value: tripcomposer
      - key: EVENT_BUS_URL
        value: http://event-bus:4000
      - key: BOOKING_SERVICE_URL
        value: http://booking-payments:3015
      - key: IDENTITY_SERVICE_URL
        value: http://identity:3011
      - key: INTERNAL_API_KEY
        sync: false
      - key: EVIDENCE_ENCRYPTION_KEY
        sync: false
      - key: CLOUDINARY_CLOUD_NAME
        sync: false
      - key: CLOUDINARY_API_KEY
        sync: false
      - key: CLOUDINARY_API_SECRET
        sync: false
      - key: LOG_LEVEL
        value: info

  - type: pserv
    name: disputes
    runtime: docker
    dockerfilePath: ./services/disputes/Dockerfile
    dockerContext: ./services/disputes
    plan: starter
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3017"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: JWT_ISSUER
        value: tripcomposer
      - key: JWT_AUDIENCE
        value: tripcomposer-services
      - key: JWKS_URI
        value: http://identity:3011/.well-known/jwks.json
      - key: EVENT_BUS_URL
        value: http://event-bus:4000
      - key: BOOKING_SERVICE_URL
        value: http://booking-payments:3015
      - key: PAYMENTS_SERVICE_URL
        value: http://booking-payments:3015
      - key: NOTIFICATION_SERVICE_URL
        value: http://notifications:3019
      - key: INTERNAL_SERVICE_TOKEN
        sync: false
      - key: LOG_LEVEL
        value: info

  - type: pserv
    name: reviews
    runtime: docker
    dockerfilePath: ./services/reviews/Dockerfile
    dockerContext: ./services/reviews
    plan: starter
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3018"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: JWT_ALGORITHM
        value: RS256
      - key: JWT_ISSUER
        value: tripcomposer
      - key: JWT_AUDIENCE
        value: tripcomposer-services
      - key: EVENT_BUS_URL
        value: http://event-bus:4000
      - key: LOG_LEVEL
        value: info

  - type: pserv
    name: notifications
    runtime: docker
    dockerfilePath: ./services/notifications/Dockerfile
    dockerContext: ./services/notifications
    plan: starter
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3019"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: EVENT_BUS_URL
        value: http://event-bus:4000
      - key: EVENT_BUS_API_KEY
        sync: false
      - key: EMAIL_FROM_ADDRESS
        value: noreply@howweplan.dev
      - key: EMAIL_PROVIDER
        value: console
      - key: ENABLE_EMAIL
        value: "true"
      - key: SMS_ENABLED
        value: "false"
      - key: PUSH_ENABLED
        value: "false"
      - key: LOG_LEVEL
        value: info
