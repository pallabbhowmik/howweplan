# ============================================================================
# HowWePlan - Docker Compose Configuration
# Production-like Environment (Supabase Cloud + Internal Event Bus)
# ============================================================================
# 
# Architecture:
#   - Supabase Cloud for database (no local postgres)
#   - Internal Event Bus Service (HTTP-based, no Redis/RabbitMQ)
#   - Single API Gateway entry point
#   - JWT keys uploaded to Render secret files (not in .env)
#
# Usage:
#   docker compose up -d          # Start all services
#   docker compose down           # Stop all services
#   docker compose logs -f        # View logs
#   docker compose ps             # Check status
#
# ============================================================================

name: tripcomposer

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  tripcomposer-network:
    driver: bridge
    name: tripcomposer-network

# ============================================================================
# SERVICES
# ============================================================================
services:
  # --------------------------------------------------------------------------
  # EVENT BUS SERVICE (HTTP-based, replaces Redis/RabbitMQ)
  # --------------------------------------------------------------------------

  event-bus:
    build:
      context: ./services/event-bus-service
      dockerfile: Dockerfile
    container_name: tripcomposer-event-bus
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4000
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:3002,http://localhost:3003}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    expose:
      - "4000"
    networks:
      - tripcomposer-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # --------------------------------------------------------------------------
  # API GATEWAY (Single Entry Point)
  # --------------------------------------------------------------------------

  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: tripcomposer-api-gateway
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3000
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:3002,http://localhost:3003}
      # Route to internal Docker service names
      IDENTITY_SERVICE_URL: http://identity:3011
      REQUESTS_SERVICE_URL: http://requests:3012
      ITINERARIES_SERVICE_URL: http://itineraries:3014
      MATCHING_SERVICE_URL: http://matching:3013
      BOOKING_PAYMENTS_SERVICE_URL: http://booking-payments:3015
      MESSAGING_SERVICE_URL: http://messaging:3016
      NOTIFICATIONS_SERVICE_URL: http://notifications:3019
      DISPUTES_SERVICE_URL: http://disputes:3017
      AUDIT_SERVICE_URL: http://audit:3010
      REVIEWS_SERVICE_URL: http://reviews:3018
      EVENT_BUS_SERVICE_URL: http://event-bus:4000
      # JWT settings (keys uploaded to Render secret files)
      JWT_ISSUER: ${JWT_ISSUER:-tripcomposer}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-tripcomposer-services}
      JWT_ALGORITHM: RS256
    ports:
      - "${GATEWAY_PORT:-8081}:3000"
    networks:
      - tripcomposer-network
    depends_on:
      event-bus:
        condition: service_healthy
      identity:
        condition: service_healthy
      requests:
        condition: service_healthy
      itineraries:
        condition: service_started
      booking-payments:
        condition: service_started
      messaging:
        condition: service_started
      notifications:
        condition: service_started
      disputes:
        condition: service_started
      audit:
        condition: service_healthy
      reviews:
        condition: service_started

  # --------------------------------------------------------------------------
  # BACKEND MICROSERVICES (Internal Only)
  # --------------------------------------------------------------------------

  audit:
    build:
      context: ./services/audit
      dockerfile: Dockerfile
    container_name: tripcomposer-audit
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      LOCAL_DEV_MODE: "true"
      PORT: 3010
      # Supabase Cloud
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      DATABASE_URL: ${DATABASE_URL}
      INTERNAL_SERVICE_SECRET: ${INTERNAL_SERVICE_SECRET:-dev-internal-secret-32chars}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    expose:
      - "3010"
    networks:
      - tripcomposer-network
    depends_on:
      event-bus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  identity:
    build:
      context: ./services/identity
      dockerfile: Dockerfile
    container_name: tripcomposer-identity
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3011
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:3002,http://localhost:3003}
      # Supabase Cloud
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      DATABASE_URL: ${DATABASE_URL}
      # JWT (RS256 - keys uploaded to Render secret files)
      JWT_ALGORITHM: RS256
      JWT_ISSUER: ${JWT_ISSUER:-tripcomposer}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-tripcomposer-services}
      # Event Bus (HTTP)
      EVENT_BUS_URL: http://event-bus:4000
      EVENT_BUS_API_KEY: ${EVENT_BUS_API_KEY:-dev-event-bus-api-key-16}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    expose:
      - "3011"
    networks:
      - tripcomposer-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3011/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      event-bus:
        condition: service_healthy
      audit:
        condition: service_healthy

  requests:
    build:
      context: ./services/requests
      dockerfile: Dockerfile
    container_name: tripcomposer-requests
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3012
      # Supabase Cloud
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      DATABASE_URL: ${DATABASE_URL}
      # JWT (RS256)
      JWT_ALGORITHM: RS256
      JWT_ISSUER: ${JWT_ISSUER:-tripcomposer}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-tripcomposer-services}
      # Event Bus (HTTP)
      EVENT_BUS_URL: http://event-bus:4000
      # Business config
      DAILY_REQUEST_CAP: ${DAILY_REQUEST_CAP:-5}
      MAX_OPEN_REQUESTS: ${MAX_OPEN_REQUESTS:-3}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    expose:
      - "3012"
    networks:
      - tripcomposer-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3012/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      event-bus:
        condition: service_healthy
      audit:
        condition: service_healthy
      identity:
        condition: service_healthy

  matching:
    build:
      context: ./services/matching
      dockerfile: Dockerfile
    container_name: tripcomposer-matching
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3013
      # Supabase Cloud
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      DATABASE_URL: ${DATABASE_URL}
      # Event Bus (HTTP)
      EVENT_BUS_URL: http://event-bus:4000
      EVENT_BUS_API_KEY: ${EVENT_BUS_API_KEY:-dev-event-bus-api-key-16}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    expose:
      - "3013"
    networks:
      - tripcomposer-network
    depends_on:
      event-bus:
        condition: service_healthy
      audit:
        condition: service_healthy
      requests:
        condition: service_started

  itineraries:
    build:
      context: ./services/itineraries
      dockerfile: Dockerfile
    container_name: tripcomposer-itineraries
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3014
      # Supabase Cloud
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      DATABASE_URL: ${DATABASE_URL}
      # JWT (RS256)
      JWT_ALGORITHM: RS256
      JWT_ISSUER: ${JWT_ISSUER:-tripcomposer}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-tripcomposer-services}
      # Event Bus (HTTP)
      EVENT_BUS_URL: http://event-bus:4000
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-dev-internal-api-key-32chars}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    expose:
      - "3014"
    networks:
      - tripcomposer-network
    depends_on:
      event-bus:
        condition: service_healthy
      audit:
        condition: service_healthy

  booking-payments:
    build:
      context: ./services/booking-payments
      dockerfile: Dockerfile
    container_name: tripcomposer-booking-payments
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3015
      # Supabase Cloud
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      DATABASE_URL: ${DATABASE_URL}
      # JWT (RS256)
      JWT_ALGORITHM: RS256
      JWT_ISSUER: ${JWT_ISSUER:-tripcomposer}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-tripcomposer-services}
      # Event Bus (HTTP)
      EVENT_BUS_URL: http://event-bus:4000
      EVENT_BUS_API_KEY: ${EVENT_BUS_API_KEY:-dev-event-bus-api-key-16}
      # Razorpay (configure when ready)
      RAZORPAY_KEY_ID: ${RAZORPAY_KEY_ID:-}
      RAZORPAY_KEY_SECRET: ${RAZORPAY_KEY_SECRET:-}
      RAZORPAY_WEBHOOK_SECRET: ${RAZORPAY_WEBHOOK_SECRET:-}
      ENABLE_LIVE_PAYMENTS: "false"
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-dev-internal-api-key-32chars}
      PLATFORM_COMMISSION_RATE: "0.10"
      BOOKING_FEE_RATE: "0.029"
      BOOKING_FEE_FIXED_CENTS: "30"
      LOG_LEVEL: ${LOG_LEVEL:-info}
    expose:
      - "3015"
    networks:
      - tripcomposer-network
    depends_on:
      event-bus:
        condition: service_healthy
      audit:
        condition: service_healthy

  messaging:
    build:
      context: ./services/messaging
      dockerfile: Dockerfile
    container_name: tripcomposer-messaging
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3016
      # Supabase Cloud
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      DATABASE_URL: ${DATABASE_URL}
      # JWT (RS256)
      JWT_ALGORITHM: RS256
      JWT_ISSUER: ${JWT_ISSUER:-tripcomposer}
      # Event Bus (HTTP)
      EVENT_BUS_URL: http://event-bus:4000
      # Service URLs
      BOOKING_SERVICE_URL: http://booking-payments:3015
      IDENTITY_SERVICE_URL: http://identity:3011
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-dev-internal-api-key-32chars}
      EVIDENCE_ENCRYPTION_KEY: ${EVIDENCE_ENCRYPTION_KEY:-dev-encryption-key-32-characters}
      # Cloudinary (for file attachments)
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    expose:
      - "3016"
    networks:
      - tripcomposer-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3016/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      event-bus:
        condition: service_healthy
      audit:
        condition: service_healthy

  disputes:
    build:
      context: ./services/disputes
      dockerfile: Dockerfile
    container_name: tripcomposer-disputes
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3017
      # Supabase Cloud
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      DATABASE_URL: ${DATABASE_URL}
      # JWT
      JWT_ISSUER: ${JWT_ISSUER:-tripcomposer}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-tripcomposer-services}
      JWKS_URI: http://identity:3011/.well-known/jwks.json
      # Event Bus (HTTP)
      EVENT_BUS_URL: http://event-bus:4000
      # Service URLs
      BOOKING_SERVICE_URL: http://booking-payments:3015
      PAYMENTS_SERVICE_URL: http://booking-payments:3015
      NOTIFICATION_SERVICE_URL: http://notifications:3019
      INTERNAL_SERVICE_TOKEN: ${INTERNAL_SERVICE_TOKEN:-dev-internal-service-token}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    expose:
      - "3017"
    networks:
      - tripcomposer-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3017/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      event-bus:
        condition: service_healthy
      audit:
        condition: service_healthy
      booking-payments:
        condition: service_started

  reviews:
    build:
      context: ./services/reviews
      dockerfile: Dockerfile
    container_name: tripcomposer-reviews
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3018
      # Supabase Cloud
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      DATABASE_URL: ${DATABASE_URL}
      # JWT (RS256)
      JWT_ALGORITHM: RS256
      JWT_ISSUER: ${JWT_ISSUER:-tripcomposer}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-tripcomposer-services}
      # Event Bus (HTTP)
      EVENT_BUS_URL: http://event-bus:4000
      LOG_LEVEL: ${LOG_LEVEL:-info}
    expose:
      - "3018"
    networks:
      - tripcomposer-network
    depends_on:
      event-bus:
        condition: service_healthy
      audit:
        condition: service_healthy

  notifications:
    build:
      context: ./services/notifications
      dockerfile: Dockerfile
    container_name: tripcomposer-notifications
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3019
      # Supabase Cloud
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      DATABASE_URL: ${DATABASE_URL}
      # Event Bus (HTTP)
      EVENT_BUS_URL: http://event-bus:4000
      EVENT_BUS_API_KEY: ${EVENT_BUS_API_KEY:-dev-event-bus-api-key-16}
      # Email config
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-noreply@howweplan.dev}
      EMAIL_PROVIDER: ${EMAIL_PROVIDER:-console}
      SMS_PROVIDER: console
      PUSH_PROVIDER: console
      ENABLE_EMAIL: "true"
      SMS_ENABLED: "false"
      PUSH_ENABLED: "false"
      LOG_LEVEL: ${LOG_LEVEL:-info}
    expose:
      - "3019"
    networks:
      - tripcomposer-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3019/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      event-bus:
        condition: service_healthy
      audit:
        condition: service_healthy
