# Frontend â†’ Backend Data Flow

## Current Architecture (CORRECT Pattern)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND APPS                                 â”‚
â”‚  (user-web, agent-web, admin-web)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                                    â”‚                  â”‚
         â”‚ âœ… ALLOWED                        â”‚ âœ… ALLOWED      â”‚ âŒ FORBIDDEN
         â”‚ Authentication                     â”‚ Public Data      â”‚ Direct Service
         â”‚ Session Management                 â”‚ (Read-Only)      â”‚ Calls
         â–¼                                    â–¼                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  Supabase Auth  â”‚                  â”‚  Supabase DB    â”‚        â”‚
â”‚   .auth.xxx()   â”‚                  â”‚  (destinations, â”‚        â”‚
â”‚                 â”‚                  â”‚   countries)    â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
                                                                 â”‚
         â”‚ âœ… CORRECT                                           â”‚
         â”‚ All Other Operations                                  â”‚
         â–¼                                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚              API GATEWAY                                      â”‚â”‚
â”‚  https://howweplan-gateway.onrender.com                      â”‚â”‚
â”‚                                                               â”‚â”‚
â”‚  Routes:                                                      â”‚â”‚
â”‚    /api/identity/*   â†’ Identity Service                      â”‚â”‚
â”‚    /api/requests/*   â†’ Requests Service                      â”‚â”‚
â”‚    /api/bookings/*   â†’ Booking-Payments Service              â”‚â”‚
â”‚    /api/messaging/*  â†’ Messaging Service                     â”‚â”‚
â”‚    /api/matching/*   â†’ Matching Service                      â”‚â”‚
â”‚    ... and more                                               â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
         â”‚                                                       â”‚
         â”‚ Gateway routes to                                     â”‚
         â”‚ microservices                                         â”‚
         â–¼                                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                    BACKEND MICROSERVICES                      â”‚â”‚
â”‚  (Identity, Requests, Matching, Messaging, etc.)             â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
         â”‚                                                       â”‚
         â”‚ Services have                                         â”‚
         â”‚ full DB access                                        â”‚
         â–¼                                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                     SUPABASE DATABASE                         â”‚â”‚
â”‚  (users, travel_requests, bookings, messages, etc.)          â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                 â”‚
     âŒ These paths are NOT allowed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     (Direct service calls, Direct DB access)
```

---

## âœ… CORRECT Data Flow Examples

### Example 1: User Profile Update
```
Frontend (user-web)
    â”‚
    â”‚ PUT https://howweplan-gateway.onrender.com/api/identity/profile
    â”‚ { firstName: "John" }
    â”‚ Authorization: Bearer <token>
    â–¼
API Gateway
    â”‚ Validates token
    â”‚ Routes to Identity Service
    â–¼
Identity Service
    â”‚ Checks permissions
    â”‚ Applies business logic
    â”‚ Emits ProfileUpdated event
    â–¼
Supabase DB
    â”‚ UPDATE users SET first_name = 'John'
    â–¼
Event Bus
    â”‚ ProfileUpdated event
    â”‚ â†’ Audit Service (logs change)
    â”‚ â†’ Notifications Service (notifies user)
```

### Example 2: Create Travel Request
```
Frontend (user-web)
    â”‚
    â”‚ POST https://howweplan-gateway.onrender.com/api/requests
    â”‚ { destination: "Goa", dates: [...] }
    â”‚ Authorization: Bearer <token>
    â–¼
API Gateway
    â”‚ Validates token
    â”‚ Routes to Requests Service
    â–¼
Requests Service
    â”‚ Validates input
    â”‚ Checks user permissions
    â”‚ Creates request
    â”‚ Emits RequestCreated event
    â–¼
Supabase DB
    â”‚ INSERT INTO travel_requests
    â–¼
Event Bus
    â”‚ RequestCreated event
    â”‚ â†’ Matching Service (finds agents)
    â”‚ â†’ Notifications Service (notifies user)
    â”‚ â†’ Audit Service (logs creation)
```

### Example 3: Send Message
```
Frontend (user-web or agent-web)
    â”‚
    â”‚ POST https://howweplan-gateway.onrender.com/api/messaging/messages
    â”‚ { conversationId: "...", content: "Hello" }
    â”‚ Authorization: Bearer <token>
    â–¼
API Gateway
    â”‚ Validates token
    â”‚ Routes to Messaging Service
    â–¼
Messaging Service
    â”‚ Validates permissions
    â”‚ Checks conversation access
    â”‚ Saves message
    â”‚ Emits MessageSent event
    â–¼
Supabase DB
    â”‚ INSERT INTO messages
    â–¼
Event Bus
    â”‚ MessageSent event
    â”‚ â†’ WebSocket (real-time delivery)
    â”‚ â†’ Notifications Service (push notification)
    â”‚ â†’ Audit Service (logs message)
```

---

## âŒ WRONG Data Flow (Current Violations)

### Anti-Pattern: Direct Database Access
```
Frontend (user-web)
    â”‚
    â”‚ const { data } = await supabase
    â”‚   .from('travel_requests')        âŒ WRONG!
    â”‚   .select('*')
    â”‚   .eq('user_id', userId)
    â–¼
Supabase DB
    â”‚ SELECT * FROM travel_requests
    â”‚
    â”‚ Problems:
    â”‚ âœ— Bypasses backend services
    â”‚ âœ— No business logic validation
    â”‚ âœ— No event emission
    â”‚ âœ— No audit logging
    â”‚ âœ— Security relies only on RLS
    â”‚ âœ— Complex queries in frontend
```

---

## ğŸ¯ The Three Rules

### Rule 1: Authentication â†’ Supabase Auth
```typescript
// âœ… CORRECT
const supabase = getSupabaseClient();
await supabase.auth.signInWithPassword({ email, password });
await supabase.auth.getSession();
await supabase.auth.signOut();
```

### Rule 2: Public Reference Data â†’ Supabase (Read-Only)
```typescript
// âœ… CORRECT
const { data: destinations } = await supabase
  .from('destinations')  // Public, static, read-only
  .select('id, name, country')
  .eq('is_active', true);
```

### Rule 3: Everything Else â†’ Backend Services
```typescript
// âœ… CORRECT
const response = await fetch(
  `https://howweplan-gateway.onrender.com/api/requests/user/${userId}`,
  { headers: { 'Authorization': `Bearer ${session.access_token}` } }
);
const requests = await response.json();
```

---

## ğŸ”„ Service Responsibilities

**All services accessed via:** `https://howweplan-gateway.onrender.com`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Identity Service          /api/identity/*                  â”‚
â”‚  â†’ User profiles, settings, authentication business logic   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Requests Service          /api/requests/*                  â”‚
â”‚  â†’ Travel requests CRUD, matching orchestration             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Matching Service          /api/matching/*                  â”‚
â”‚  â†’ Agent-request matching, acceptance, scoring              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Messaging Service         /api/messaging/*                 â”‚
â”‚  â†’ Conversations, messages, real-time chat                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Booking-Payments Service  /api/bookings/*                  â”‚
â”‚  â†’ Booking lifecycle, payment processing, refunds           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Itineraries Service       /api/itineraries/*               â”‚
â”‚  â†’ Itinerary CRUD, obfuscation, proposal management         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Notifications Service     /api/notifications/*             â”‚
â”‚  â†’ Push notifications, email, SMS, preferences              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Reviews Service           /api/reviews/*                   â”‚
â”‚  â†’ Reviews, ratings, moderation                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Disputes Service          /api/disputes/*                  â”‚
â”‚  â†’ Dispute management, resolution workflow                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Audit Service             /api/audit/*                     â”‚
â”‚  â†’ System-wide audit logging, compliance                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Benefits of This Architecture

| Benefit | Description |
|---------|-------------|
| **Security** | Backend enforces authorization, not just RLS |
| **Business Logic** | Domain logic centralized in services |
| **Events** | State changes emit events for other services |
| **Audit** | All operations logged automatically |
| **Testing** | Backend logic isolated and testable |
| **Performance** | Optimized queries, caching, batching |
| **Flexibility** | Can swap databases without changing frontend |
| **Monitoring** | Centralized metrics and observability |

---

## ğŸ” How to Check Your Code

Before pushing code, ask:

1. Am I using `supabase.from()`? 
   - If YES â†’ Is it auth or public reference data?
     - If NO â†’ **Use backend API instead**

2. Am I writing to the database?
   - If YES â†’ **Must go through backend service**

3. Am I joining tables or doing complex queries?
   - If YES â†’ **Must be done in backend service**

4. Am I changing state (create/update/delete)?
   - If YES â†’ **Must emit events through backend**

**When in doubt, use the backend service.**
